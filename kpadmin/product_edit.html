<style>
   .text-help { font-size: 11px; font-weight: 500; color: #ff5722; }

</style>
<nav aria-label="breadcrumb">
   <ol class="breadcrumb" >
      <li class="breadcrumb-item"><a href="/cpanel/home">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="cpanel/product/lists">Products</a></li>
      <li class="breadcrumb-item active" aria-current="page">Edit</li>
   </ol>
</nav>
<!--/end Breadcrumb-->

<!-- // Start Content on PAGE /////////////////////////////////////////////////////// -->
<div class="row">
   <div class="content-title">
      <div class="col-md-7 col-sm-8 col-xs-12">
         <h2><b>Product Editor</b></h2>
      </div><!--/col-->
      <div class="col-md-5 col-sm-4 col-xs-12">
         <div class="dataTables_wrapper">
            <!-- <form method="GET">
                <div class="dataTables_custom" style="width:100%;">
                  <div class="dateMonthPicker">
                        <div class="input-prepend input-group">
                            <span class="add-on input-group-addon"><i class="fa fa-fw fa-flask"></i></span>
                            <select id="productid" name="productid" class="form-control input-sm selectpicker selectCustomW100" style="width:100%;" onchange="this.form.submit()">

                            </select>
                        </div>
                    </div>
                </div>
            </form> -->
         </div>
      </div><!--/col-->
   </div><!--/content-title-->
</div><!--/row-->

<div class="row" id='product_edit_page'>
   <div class="col-md-12 col-sm-12 col-xs-12">
      <div class="x_panel">
         <div class="x_title">
            <p class="text-th">หน้าแก้ไข สินค้า <span>( <span class="product_id"></span> | <span class="product_product_name"></span> )</span> <b></b></p>

            <!-- <button class="btn btn-danger btn-sm pull-right btn-delPRD" data-productid=""><i class="glyphicon glyphicon-trash"></i></button>-->

         </div><!--/x_title-->


         <div class="x_content">
            <form id="editPRD" class="form-horizontal form-label-left" method="POST" data-parsley-validate="" novalidate>
               <input type="hidden" name="action" value="editPRD">
               <input id="bywho" name="bywho" value="" style="display:none;" />
               <input id="when" name="when" value="" style="display:none;" />
               <div class="row">
                  <div class="col col-md-3 col-sm-4 col-xs-12">
                    	<div class="form-group" style="text-align:center;">

                        <!-- <img id="preview" src="" class="img-responsive " style="max-height:300px; margin:0 auto;"> -->

                        <img id="preview" src="/images/products/" class="img-responsive product_product_image" style="max-height:300px; margin:0 auto;">

                        <div style=" width:100%; margin-top:30px; padding:10px; border:1px solid #e6ecf5; border-radius: 2px; overflow:hidden;">
                           <input type="file" name="previewimage" id="previewimage" >
                           <input id="productimage" name="productimage" value=""  style="display:none;" />
                           <div> ขนาดไฟล์ที่อนุญาตน้อยกว่า 2 MB  <!--Allowed file size is less than 2 MB --></div>
                        </div>
                     </div>

                  </div><!--/col-->
                  <div class="col col-md-9 col-sm-8 col-xs-12">
                     <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12"><span class="required">*</span> Product Name</label>
                        <div class="col-md-9 col-sm-9 col-xs-12">
                           <input class="form-control product_product_name" type="text" id="productname" name="productname" value="" required="required" />
                           <span class="text-help  chk_name"></span>
                        </div>
                     </div>
                     <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12"><span class="required">*</span> SKU</label>
                        <div class="col-md-9 col-sm-9 col-xs-12">
                           <input class="form-control product_SKU" type="text" id="sku" name="sku" value="" required="required" />
                           <span class="text-help chk_sku"></span>
                        </div>
                     </div>
                     <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">
                           <span class="required">*</span> Price
                        </label>
                        <div class="col-md-3 col-sm-3 col-xs-12">
                           <input class="form-control product_init_price" type="number" id="price" name="price" value="" style="width:calc(100% - 40px); display:inline-block;" required />

                           <span class="unit">THB</span>
                           <span class="text-help chk_price"></span>
                        </div>
                     </div>
                     <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">
                           <span class="required">*</span> Category
                        </label>
                        <div class="col-md-9 col-sm-9 col-xs-12">
                           <select id="select_category" name="category" class="product_category form-control input-sm selectpicker selectCustomW100">
                              <option data-content="" value=""> </option>

                           </select>
                           <span class="text-help chk_category"></span>
                        </div>
                     </div>
                     <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">Description</label>
                        <div class="col-md-9 col-sm-9 col-xs-12">
                           <textarea class="resizable_textarea form-control product_description" rows="5" id="description" name="description"></textarea>
                        </div>
                     </div>

                     <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">Status</label>
                        <div class="col-md-9 col-sm-9 col-xs-12">
                           <select id="status" class="product_status form-control input-sm selectpicker selectCustomW100">
                              <option value="1">เปิดการใช้งาน</option>
                              <option value="0">ปิดการใช้งาน</option>
                           </select>

                        </div>
                     </div>

                  </div><!--/col-->
               </div><!--/row-->

               <div class="row">
                  <div class="ln_solid"></div>
                  <div class="col-md-3 col-sm-6 col-xs-12"><a href="/cpanel/product/lists" class="alink btn btn-default btn-lg btn-block">Back to Product Lists</a></div>
                  <div class="col-md-9 col-sm-6 col-xs-12"><button class="btn btn-primary btn-lg btn-block" type="submit" >Submit Edited</button></div>
               </div><!--/row-->
            </form>
         </div><!--/x_content-->
      </div><!--/x_panel-->
   </div><!--/col-md-12-->

</div><!--/row-->

<script >
   var productimage_src;
   $('.alink').off("click");
   $('.alink').on('click', function (obj) {
      go2View($(obj.target).attr('href'), 'Kapook Vending');
      return false;
   });


   /* ฟังก์ชั่นเกี่ยวกับรูปภาพ */
   function readURL(input) {
      if (input.files && input.files[0]) {
         var reader = new FileReader();

         reader.onload = function (e) {
            $('#preview').attr('src', e.target.result);
            productimage_src = e.target.result;
         }

         reader.readAsDataURL(input.files[0]);
      }
   }

   /* URL ของรูปภาพ */
   $("#previewimage").change(function () {
      readURL(this);
   });



   var productid_editing; // กำหนดตัวแปร ใช้ร่วมกันไว้ข้างนอก


   // 1. ถ้ามีหมวดสินค้าจากตารางอื่น ให้ทำก่อน
   function product_showdata(productid) {
      // Load Category มาก่อน
      $.get('/api/member/categorylist', function (data) {  // หยิบที่สร้างใน nodered มา
         var seldata = '';  // ตั้งชื่อตัวแปรใหม่ ไปใช้กับ <select
         for (var x = 0; x < data.length; x++) {
            seldata += '<option value="' + data[x]._id + '">' + '(' + data[x]._id + ')  ' + data[x].name + '</option>';
         }
         seldata += '<option value="' + 0 + '">...</option>';
         $('#select_category').html(seldata);  // <select id ="select_category"

         product_get(productid);  // ให้ไปทำ ฟังก์ชั่น product_get ต่อ
      });
   }

   // 2. ทำข้อ 1 เสร็จ แสดงข้อมูลตาราง product รับค่า productid
   function product_get(productid) {
      // กำหนดรับค่า productid นี้ ไปกำหนดที่ Nodered
      $.get('/api/member/productid/' + productid, function (data) {
         productid_editing = productid;

         var objjquery = $('#product_edit_page');  //  <div class="row product_edit_page"> แก้ไขข้อมูล
         setdatabyclass(objjquery, 'product', data);  // product ชื่อเรียกนำหน้านำไปใช้คือ  <div class="product_name"
         console.log('viewing data');


         // จัดการ style Remove Class
         if ($('#productname').val()) {
            $(".chk_name").removeClass('text-help');
         }

         if ($('#sku').val()) {
            $(".chk_sku").removeClass('text-help');
         }

         if ($('#price').val()) {
            $(".chk_price").removeClass('text-help');
         }

         if ($('#select_category').val()) {
            $(".chk_category").removeClass('text-help');
         }


      });
   }


   //Upload Image
   /*
    var previewIMG = function() {
    var photo = document.getElementById("previewimage");
    var files = photo.files;
    for (var i = 0; i < files.length; i++) { var file = files[i]; }
    var reader = new FileReader();
    reader.onloadend = function() {
    //console.log('BASE64 RESULT = ', reader.result)
    preview.src = reader.result; tempimage=reader.result;
    $("#productimage").val(tempimage);
    }
    reader.readAsDataURL(file);
    }

    */



   $('#editPRD').on('submit', function () {  // ใช้กับ <form id="editPRD"
      var errortext;
      // กำหนดตัวแปรแต่ละตัว ที่มาจากฟอร์ม
      var productname = $('#productname').val();
      var sku = $('#sku').val();
      var price = Number($('#price').val());
      var category = Number($('#select_category').val());
      var description = $('#description').val();
      var status = Number($('#status').val());
      //console.log("IMAGE DATA",productimage_src);
      if (productname == '') {
         // ค่าว่าง
         errortext = 'กรุณากรอก Product Name';
         $(".chk_name").show();
         $(".chk_name").addClass("text-help");
         $('.chk_name').html('จำเป็นต้องกรอก');
      } else {
         // กรอกข้อมูลเข้ามา
         $(".chk_name").hide();
         $(".chk_name").removeClass("text-help");
      }

      if (sku == '') {
         errortext = 'กรุณากรอก SKU';
         $(".chk_sku").show();
         $(".chk_sku").addClass("text-help");
         $('.chk_sku').html('จำเป็นต้องกรอก');
      } else {
         $(".chk_sku").hide();
         $(".chk_sku").removeClass("text-help");
      }


      if (price == '') {
         errortext = 'กรุณากรอก Price';
         $(".chk_price").show();
         $(".chk_price").addClass("text-help");
         $('.chk_price').html('จำเป็นต้องกรอก');
      } else {
         $(".chk_price").hide();
         $(".chk_price").removeClass("text-help");
      }

      if (category == '') {
         errortext = 'กรุณากรอก Category';
         $(".chk_category").show();
         $(".chk_category").addClass("text-help");
         $('.chk_category').html('จำเป็นต้องกรอก');
      } else {
         $(".chk_category").hide();
         $(".chk_category").removeClass("text-help");
      }

      if (productimage_src.length > '2097152') {
         errortext = 'กรุณาเลือกรูปภาพขนาดไฟล์ที่อนุญาตน้อยกว่า 2 MB';
      }


      console.log("Image Size : ", productimage_src.length, " KB");

      var title = 'Edit Product';
      if (errortext) {
         // แจ้ง error
         new PNotify({
            title: title + ' Error',
            text: errortext,
            modules: {
               Animate: {
                  animate: true,
                  inClass: 'zoomInLeft',
                  outClass: 'zoomOutRight'
               }
            }
         });

         return false;
      } else {


         console.log("SUBMIT" + '/api/member/productid/' + productid_editing);
         var postdata = {prd_id: productid_editing, prd_name: productname, prd_sku: sku, prd_price: price, prd_category: category, prd_description: description, prd_status: status, product_image: productimage_src};

         console.log(postdata);
         $.post('/api/member/productid/' + productid_editing, postdata).done(function (data) {

            product_image:productimage_src = null;   // Clear memory

            //  แจ้งบันทึกสำเร็จ
            new PNotify({
               title: title + ' Success',
               text: 'บันทึกข้อมูลสำเร็จ',
               type: 'success'
            });
            console.log("SUBMIT data " + data);
         });
      }

      console.log("return false");
      return false;

   });

</script>
<!-- // End Content on PAGE /////////////////////////////////////////////////////// -->
